# .devcontainer/Dockerfile.dev
# Extends the base upside2-md Dockerfile with development and debugging tools

FROM .devcontainer/Dockerfile
LABEL maintainer="Oliver Kleinmann"

# Switch to root for package installation
USER root

# Install development and debugging tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    gdb \
    gdbserver \
    vim \
    nano \
    hexdump \
    && rm -rf /var/lib/apt/lists/*

# Install additional development conda packages
RUN conda run -n upside2-env conda install -c conda-forge -y \
    gdb \
    ipdb \
    pdb++ \
    line_profiler \
    memory_profiler \
    py-spy \
    && conda clean -afy

# Configure gdb for better debugging experience
RUN echo "set auto-load safe-path /" >> /home/user/.gdbinit && \
    echo "set print pretty on" >> /home/user/.gdbinit && \
    echo "set print array on" >> /home/user/.gdbinit && \
    echo "set print array-indexes on" >> /home/user/.gdbinit && \
    chown user:user /home/user/.gdbinit

# Enable core dumps for debugging
RUN echo "* soft core unlimited" >> /etc/security/limits.conf && \
    echo "* hard core unlimited" >> /etc/security/limits.conf

# Enable DEBUG option in CMakeLists files
RUN sed -i 's/option(DEBUG "Enable debug build" OFF)/option(DEBUG "Enable debug build" ON)/' /home/user/upside2-md/src/CMakeLists_x86.txt

# Switch back to non-root user
USER user

# Keep the existing entrypoint and command
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["bash"]
