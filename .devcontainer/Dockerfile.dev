# .devcontainer/Dockerfile.dev
# Extends the base upside2-md Dockerfile with development and debugging tools

FROM upside2-base:latest
#FROM oliverkleinmann/upside2-md:latest
LABEL maintainer="Oliver Kleinmann"

# Switch to root for package installation
USER root

# Install development and debugging tools
# binutils provides gprof for gmon support
RUN apt-get update && apt-get install -y --no-install-recommends \
    gdb \
    gdbserver \
    vim \
    nano \
    util-linux \
    binutils \
    ccache \
    git \
    clang \
    curl \
    doxygen \
    graphviz \
    asciidoctor \
    tree \
    && rm -rf /var/lib/apt/lists/*

# Install Python development packages
RUN conda run -n upside2-env conda install -c conda-forge -y \
    ipdb \
    pdbpp \
    line_profiler \
    memory_profiler \
    py-spy \
    flake8 \
    black \
    mypy \
    pre-commit \
    && conda clean -afy

# Configure ccache for persistent caching
ENV CCACHE_DIR=/upside2-md/.ccache
ENV CCACHE_MAXSIZE=12G
RUN mkdir -p /upside2-md/.ccache && \
    chmod 777 /upside2-md/.ccache

# Configure gdb for better debugging experience
RUN echo "set auto-load safe-path /" >> /home/user/.gdbinit && \
    echo "set print pretty on" >> /home/user/.gdbinit && \
    echo "set print array on" >> /home/user/.gdbinit && \
    echo "set print array-indexes on" >> /home/user/.gdbinit && \
    chown user:user /home/user/.gdbinit

# Enable core dumps for debugging
RUN echo "* soft core unlimited" >> /etc/security/limits.conf && \
    echo "* hard core unlimited" >> /etc/security/limits.conf

# Set environment variables for upside2-md
ENV MY_PYTHON="/opt/conda"
ENV EIGEN_HOME="/usr/include/eigen3"
ENV UPSIDE_HOME="/upside2-md"

# Switch back to non-root user
USER user

# Declare volume for ccache persistence
VOLUME ["/upside2-md/.ccache"]

# Keep the existing entrypoint and command
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["bash"]
